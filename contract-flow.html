<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Creation Flow - Payment Test Bench</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Progress Stepper Styles */
        .step {
            transition: all 0.2s;
        }

        .step.clickable:hover {
            opacity: 0.8;
        }

        .step-circle {
            background-color: #E5E7EB;
            color: #6B7280;
            transition: all 0.3s;
        }

        .step.completed .step-circle {
            background-color: #10B981;
            color: white;
        }

        .step.completed .step-number {
            display: none;
        }

        .step.completed .step-check {
            display: block;
        }

        .step.current .step-circle {
            background-color: #3B82F6;
            color: white;
            animation: pulse 2s infinite;
        }

        .step.upcoming .step-circle {
            background-color: #F3F4F6;
            color: #9CA3AF;
        }

        .step-connector {
            background-color: #E5E7EB;
            transition: background-color 0.3s;
        }

        .step.completed + .step-connector {
            background-color: #10B981;
        }

        .step-label {
            color: #6B7280;
            transition: color 0.3s;
        }

        .step.completed .step-label,
        .step.current .step-label {
            color: #111827;
            font-weight: 600;
        }

        .step.upcoming .step-label {
            color: #9CA3AF;
        }

        /* Mobile dots */
        .step-dot {
            background-color: #D1D5DB;
            transition: all 0.3s;
        }

        .step-dot.completed {
            background-color: #10B981;
        }

        .step-dot.current {
            background-color: #3B82F6;
            width: 0.75rem;
            height: 0.75rem;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        /* Form error styles */
        .error {
            border-color: #EF4444 !important;
        }

        .error-message {
            color: #EF4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Offer card hover */
        .offer-card {
            transition: all 0.2s;
        }

        .offer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .offer-card.selected {
            border-color: #3B82F6;
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* Config panel slide */
        .config-panel {
            transition: transform 0.3s ease-in-out;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 5rem;
            right: 1rem;
            max-width: 24rem;
            z-index: 60;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            background-color: #9CA3AF !important;
            color: #E5E7EB !important;
        }

        button:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navigation will be injected by nav.js -->

    <!-- Config Panel Toggle (Floating Button) -->
    <button id="config-toggle" class="fixed top-20 right-4 z-40 p-3 bg-white rounded-full shadow-lg hover:bg-gray-50 transition border border-gray-200">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
    </button>

    <!-- Configuration Panel Sidebar -->
    <aside id="config-panel" class="config-panel fixed top-16 right-0 w-80 h-[calc(100vh-4rem)] bg-white border-l border-gray-200 shadow-lg transform transition-transform duration-300 translate-x-full z-30 overflow-y-auto">
        <div class="p-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold">Configuration</h2>
                <button id="config-close" class="p-1 hover:bg-gray-100 rounded transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- API Configuration (hidden - using global config) -->
            <section class="mb-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">API Settings</h3>

                <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-blue-900">Using Global Configuration</p>
                            <p class="text-xs text-blue-700 mt-1">API credentials are managed via the global Config button in the navigation bar.</p>
                        </div>
                    </div>
                </div>

                <!-- Hidden fields populated by global config -->
                <input type="hidden" id="apiKey">
                <input type="hidden" id="apiBaseUrl">

                <label class="block mb-3">
                    <span class="text-sm font-medium">Environment</span>
                    <select id="environment" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="sandbox">Sandbox</option>
                        <option value="test">Test</option>
                        <option value="live">Live</option>
                    </select>
                </label>
            </section>

            <!-- Widget Configuration -->
            <section class="mb-6 border-t border-gray-200 pt-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Widget Settings</h3>

                <label class="block mb-3">
                    <span class="text-sm font-medium">Country Code</span>
                    <select id="countryCode" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="DE">Germany (DE)</option>
                        <option value="US">United States (US)</option>
                        <option value="GB">United Kingdom (GB)</option>
                        <option value="CH">Switzerland (CH)</option>
                        <option value="AT">Austria (AT)</option>
                        <option value="FR">France (FR)</option>
                    </select>
                </label>

                <label class="block mb-3">
                    <span class="text-sm font-medium">Currency</span>
                    <select id="currency" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="EUR">EUR (€)</option>
                        <option value="USD">USD ($)</option>
                        <option value="GBP">GBP (£)</option>
                        <option value="CHF">CHF (Fr)</option>
                    </select>
                </label>

                <label class="block mb-3">
                    <span class="text-sm font-medium">Locale</span>
                    <select id="locale" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="de-DE">German (de-DE)</option>
                        <option value="en-US">English US (en-US)</option>
                        <option value="en-GB">English UK (en-GB)</option>
                        <option value="fr-FR">French (fr-FR)</option>
                    </select>
                </label>

                <label class="flex items-center mt-3">
                    <input type="checkbox" id="useRubiksUI" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-sm">Use Rubiks UI</span>
                </label>

                <label class="flex items-center mt-3">
                    <input type="checkbox" id="requireDirectDebitSignature" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-sm">Require Direct Debit Signature</span>
                </label>
            </section>

            <!-- Save Button -->
            <button id="save-config" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-medium">
                Save Configuration
            </button>

            <!-- Action Buttons -->
            <div class="mt-6 pt-6 border-t border-gray-200 space-y-2">
                <button id="start-over" class="w-full bg-orange-50 text-orange-600 py-2 rounded-md hover:bg-orange-100 transition font-medium">
                    🔄 Start Over (Go to Step 1)
                </button>

                <button id="clear-data" class="w-full bg-red-50 text-red-600 py-2 rounded-md hover:bg-red-100 transition font-medium">
                    🗑️ Clear All Data
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile config panel -->
    <div id="config-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

    <!-- Main Content -->
    <main class="pt-16">
        <!-- Progress Indicator -->
        <div class="bg-white border-b border-gray-200 py-4 sticky top-16 z-10">
            <div class="container mx-auto px-4">
                <!-- Desktop: Horizontal Stepper -->
                <div class="flex items-center justify-between max-md:hidden" id="desktop-stepper">
                    <!-- Steps will be dynamically generated -->
                </div>

                <!-- Mobile: Compact Dots -->
                <div class="md:hidden">
                    <div class="flex items-center justify-center space-x-2 mb-2" id="mobile-dots">
                        <!-- Dots will be dynamically generated -->
                    </div>
                    <div class="text-center text-sm font-medium" id="current-step-name">
                        Step 1: Select Offer
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Content Container -->
        <div class="container mx-auto px-4 py-8">
            <!-- Step 1: Offer Selection -->
            <div id="step-1" class="step-content" data-step="1">
                <div class="max-w-6xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Select a Membership Offer</h1>
                    <p class="text-gray-600 mb-8">Choose the membership that best fits your needs</p>

                    <!-- Loading State -->
                    <div id="offers-loading" class="flex items-center justify-center py-12">
                        <div class="spinner"></div>
                        <span class="ml-3 text-gray-600">Loading offers...</span>
                    </div>

                    <!-- Error State -->
                    <div id="offers-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <div class="flex">
                            <svg class="w-5 h-5 text-red-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium text-red-800">Error loading offers</h3>
                                <p class="text-sm text-red-700 mt-1" id="offers-error-message"></p>
                                <button id="retry-offers" class="mt-2 text-sm font-medium text-red-800 underline hover:text-red-900">
                                    Try again
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Offers Grid -->
                    <div id="offers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                        <!-- Offers will be dynamically inserted here -->
                    </div>

                    <!-- Continue Button -->
                    <div class="mt-8 flex justify-end">
                        <button id="continue-step-1" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                            Continue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Offer Details -->
            <div id="step-2" class="step-content hidden" data-step="2">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Offer Details</h1>
                    <p class="text-gray-600 mb-8">Review the selected membership offer</p>

                    <!-- Offer Details Card -->
                    <div class="bg-white rounded-lg border-2 border-blue-200 shadow-sm p-8 mb-6">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <h2 id="offer-detail-name" class="text-2xl font-bold text-gray-900 mb-2">Loading...</h2>
                                <p id="offer-detail-description" class="text-gray-600"></p>
                            </div>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">Selected</span>
                        </div>

                        <div id="offer-detail-pricing" class="space-y-4 mb-6 border-t border-gray-200 pt-6">
                            <!-- Pricing details will be inserted here -->
                        </div>

                        <div id="offer-detail-info" class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-6">
                            <!-- Additional offer info will be inserted here -->
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between">
                        <button id="back-step-2" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            ← Back to Offers
                        </button>
                        <button id="continue-step-2" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            Continue to Personal Info →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Personal Information -->
            <div id="step-3" class="step-content hidden" data-step="3">
                <div class="max-w-3xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Your Information</h1>
                    <p class="text-gray-600 mb-8">Please provide your personal details</p>

                    <!-- Selected Offer Summary -->
                    <div id="selected-offer-summary" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="ml-2 text-sm font-medium text-blue-900">Selected Offer: <span id="offer-summary-name"></span></span>
                        </div>
                    </div>

                    <!-- Personal Information Form -->
                    <form id="personal-info-form" class="space-y-6">
                        <!-- Personal Details -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">Personal Details</h3>
                                <button type="button" id="fill-test-data" class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-md transition">
                                    Fill Test Data
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
                                        First Name <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="firstName" name="firstName" required maxlength="50"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           data-validate>
                                </div>

                                <div>
                                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
                                        Last Name <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="lastName" name="lastName" required maxlength="50"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           data-validate>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                                    Email Address <span class="text-red-500">*</span>
                                </label>
                                <input type="email" id="email" name="email" required maxlength="100"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       data-validate>
                            </div>

                            <div class="mt-4">
                                <label for="dateOfBirth" class="block text-sm font-medium text-gray-700 mb-1">
                                    Date of Birth <span class="text-red-500">*</span>
                                </label>
                                <input type="date" id="dateOfBirth" name="dateOfBirth" required
                                       min="1900-01-01" max="2009-01-01"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       data-validate>
                                <p class="mt-1 text-xs text-gray-500">You must be at least 16 years old</p>
                            </div>

                            <div class="mt-4">
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                                    Phone Number
                                </label>
                                <input type="tel" id="phone" name="phone" maxlength="20"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="+49123456789"
                                       data-validate>
                            </div>
                        </div>

                        <!-- Address -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Address</h3>

                            <div class="mb-4">
                                <label for="address.street" class="block text-sm font-medium text-gray-700 mb-1">
                                    Street Address <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="address.street" name="address.street" required maxlength="100"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       data-validate>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label for="address.city" class="block text-sm font-medium text-gray-700 mb-1">
                                        City <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="address.city" name="address.city" required maxlength="50"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           data-validate>
                                </div>

                                <div>
                                    <label for="address.postalCode" class="block text-sm font-medium text-gray-700 mb-1">
                                        Postal Code <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="address.postalCode" name="address.postalCode" required maxlength="10"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           data-validate>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label for="address.country" class="block text-sm font-medium text-gray-700 mb-1">
                                    Country <span class="text-red-500">*</span>
                                </label>
                                <select id="address.country" name="address.country" required
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        data-validate>
                                    <option value="">Select a country</option>
                                    <option value="DE">Germany</option>
                                    <option value="US">United States</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="CH">Switzerland</option>
                                    <option value="AT">Austria</option>
                                    <option value="FR">France</option>
                                </select>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between">
                            <button type="button" id="back-step-3" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                                ← Back to Offer Details
                            </button>
                            <button type="submit" id="continue-step-3" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                                Continue to Preview →
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Step 4: Preview -->
            <div id="step-4" class="step-content hidden" data-step="4">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Contract Preview</h1>
                    <p class="text-gray-600 mb-8">Review your membership contract details</p>

                    <!-- Loading State -->
                    <div id="preview-loading" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                        <p class="mt-4 text-gray-600">Loading preview...</p>
                    </div>

                    <!-- Error State -->
                    <div id="preview-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <svg class="w-6 h-6 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-red-900 mb-1">Error loading preview</h3>
                                <p id="preview-error-message" class="text-red-700"></p>
                                <button id="retry-preview" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                                    Try Again
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Content -->
                    <div id="preview-content" class="hidden space-y-6">
                        <!-- Contract Summary -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Contract Summary</h2>
                            <div id="preview-summary" class="space-y-3">
                                <!-- Summary will be inserted here -->
                            </div>
                        </div>

                        <!-- Start Date Section -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Contract Start Date</h2>
                            <div class="flex gap-3">
                                <input type="date" id="contract-start-date"
                                       class="flex-1 border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button id="apply-start-date" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition font-medium">
                                    Apply
                                </button>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">Select a future date to change the contract start date. The preview will be recalculated.</p>
                        </div>

                        <!-- Voucher Code Section -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Voucher Code</h2>
                            <div class="flex gap-3">
                                <input type="text" id="voucher-code" placeholder="Enter voucher code"
                                       class="flex-1 border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button id="apply-voucher" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-medium">
                                    Apply
                                </button>
                            </div>
                            <div id="voucher-status" class="mt-3 hidden"></div>
                        </div>

                        <!-- Payment Breakdown -->
                        <div class="bg-blue-50 rounded-lg border border-blue-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Details</h2>
                            <div id="preview-payment" class="space-y-3">
                                <!-- Payment details will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div id="preview-navigation" class="hidden flex justify-between mt-8">
                        <button id="back-step-4" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            ← Back to Personal Info
                        </button>
                        <button id="continue-step-4" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            Continue to Payment →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Recurring Payment -->
            <div id="step-5" class="step-content hidden" data-step="5">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Setup Recurring Payment</h1>
                    <p class="text-gray-600 mb-8">Select your preferred payment method for recurring charges</p>

                    <!-- Payment Widget Container -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Method</h2>

                        <!-- Loading State -->
                        <div id="recurring-payment-loading" class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
                            <p class="mt-4 text-gray-600">Loading payment widget...</p>
                        </div>

                        <!-- Error State -->
                        <div id="recurring-payment-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-red-900 mb-1">Error loading payment widget</h3>
                                    <p id="recurring-payment-error-message" class="text-red-700"></p>
                                    <button id="retry-recurring-payment" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Widget Container -->
                        <div id="recurring-payment-container" class="min-h-[400px]">
                            <!-- Payment widget will be mounted here -->
                        </div>

                        <!-- Success State -->
                        <div id="recurring-payment-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                            <div class="flex items-center text-green-700">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium">Payment method saved successfully!</span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div id="recurring-payment-navigation" class="hidden flex justify-between mt-8">
                        <button id="back-step-5" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            ← Back to Preview
                        </button>
                        <button id="continue-step-5" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium" disabled>
                            Continue to Next Step →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 6: Upfront Payment (Conditional) -->
            <div id="step-6" class="step-content hidden" data-step="6">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Upfront Payment</h1>
                    <p class="text-gray-600 mb-8">Complete your initial payment to activate your membership</p>

                    <!-- Payment Amount Display -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-lg text-gray-700">Amount Due Today:</span>
                            <span id="upfront-amount" class="text-3xl font-bold text-orange-600"></span>
                        </div>
                    </div>

                    <!-- Payment Widget Container -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Method</h2>

                        <!-- Loading State -->
                        <div id="upfront-payment-loading" class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"></div>
                            <p class="mt-4 text-gray-600">Loading payment widget...</p>
                        </div>

                        <!-- Error State -->
                        <div id="upfront-payment-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-red-900 mb-1">Error loading payment widget</h3>
                                    <p id="upfront-payment-error-message" class="text-red-700"></p>
                                    <button id="retry-upfront-payment" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Widget Container -->
                        <div id="upfront-payment-container" class="min-h-[400px]">
                            <!-- Payment widget will be mounted here -->
                        </div>

                        <!-- Success State -->
                        <div id="upfront-payment-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                            <div class="flex items-center text-green-700">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium">Payment completed successfully!</span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div id="upfront-payment-navigation" class="hidden flex justify-between mt-8">
                        <button id="back-step-6" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            ← Back to Recurring Payment
                        </button>
                        <button id="continue-step-6" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition font-medium" disabled>
                            Continue to Confirmation →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 7: Confirmation -->
            <div id="step-7" class="step-content hidden" data-step="7">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Review & Confirm</h1>
                    <p class="text-gray-600 mb-8">Please review your information before completing your membership signup</p>

                    <!-- Review Summary -->
                    <div class="space-y-6">
                        <!-- Member Information -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Member Information</h2>
                            <div id="confirm-member-info" class="space-y-2">
                                <!-- Member info will be inserted here -->
                            </div>
                        </div>

                        <!-- Membership Details -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Membership Details</h2>
                            <div id="confirm-membership-info" class="space-y-2">
                                <!-- Membership info will be inserted here -->
                            </div>
                        </div>

                        <!-- Payment Summary -->
                        <div class="bg-blue-50 rounded-lg border border-blue-200 p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Summary</h2>
                            <div id="confirm-payment-info" class="space-y-2">
                                <!-- Payment info will be inserted here -->
                            </div>
                        </div>

                        <!-- Terms & Conditions -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <label class="flex items-start">
                                <input type="checkbox" id="accept-terms" class="mt-1 mr-3 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="text-gray-700">
                                    I accept the <a href="#" class="text-blue-600 hover:underline">Terms & Conditions</a>
                                    and <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Submit Status -->
                    <div id="submit-loading" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6 text-center">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p class="text-gray-700 font-medium">Creating your membership...</p>
                        <p class="text-gray-600 text-sm mt-2">Please do not close this window</p>
                    </div>

                    <div id="submit-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mt-6">
                        <div class="flex items-start">
                            <svg class="w-6 h-6 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-red-900 mb-1">Error creating membership</h3>
                                <p id="submit-error-message" class="text-red-700"></p>
                                <button id="retry-submit" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                                    Try Again
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="submit-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-8 mt-6 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
                            <svg class="w-10 h-10 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-green-900 mb-2">Membership Created Successfully!</h3>
                        <p class="text-gray-700 mb-4">Your membership has been activated.</p>
                        <p class="text-gray-600 text-sm mb-6">Customer ID: <span id="membership-id" class="font-mono font-bold"></span></p>
                        <button id="create-another-membership" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                            Create Another Membership
                        </button>
                    </div>

                    <!-- Navigation Buttons -->
                    <div id="confirm-navigation" class="flex justify-between mt-8">
                        <button id="back-step-7" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            ← Back
                        </button>
                        <button id="submit-contract" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium text-lg" disabled>
                            Complete Membership Signup
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-20 right-4 z-60 space-y-2" style="z-index: 60;">
        <!-- Notifications will be dynamically inserted here -->
    </div>

    <!-- Payment Widget Script -->
    <script src="https://widget.dev.payment.sportalliance.com/widget.js"></script>
    <script src="config.js"></script>

    <!-- Shared Navigation -->
    <script src="nav.js"></script>
    <script>
        // Initialize navigation for this page
        Navigation.init('contract-flow');

        // Initialize global configuration on page load
        document.addEventListener('DOMContentLoaded', () => {
            GlobalConfig.initialize();
        });
    </script>

    <!-- Application JavaScript -->
    <script>
        // =================================================================
        // STORAGE MANAGER
        // =================================================================

        class StorageManager {
            constructor() {
                this.available = this.testLocalStorage();
                this.memoryFallback = {};
            }

            testLocalStorage() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    console.warn('localStorage not available:', e);
                    return false;
                }
            }

            set(key, value, ttl = null) {
                const item = {
                    value: value,
                    timestamp: Date.now(),
                    expiry: ttl ? Date.now() + ttl : null
                };

                try {
                    if (this.available) {
                        localStorage.setItem(key, JSON.stringify(item));
                        return true;
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                        console.error('localStorage quota exceeded, using memory fallback');
                        this.available = false;
                    }
                }

                this.memoryFallback[key] = item;
                return false;
            }

            get(key) {
                let item = null;

                try {
                    if (this.available) {
                        const stored = localStorage.getItem(key);
                        item = stored ? JSON.parse(stored) : null;
                    }
                } catch (e) {
                    console.error('Error reading from localStorage:', e);
                }

                if (!item) {
                    item = this.memoryFallback[key] || null;
                }

                if (!item) return null;

                if (item.expiry && Date.now() > item.expiry) {
                    this.remove(key);
                    return null;
                }

                return item.value;
            }

            remove(key) {
                try {
                    if (this.available) {
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    console.error('Error removing from localStorage:', e);
                }
                delete this.memoryFallback[key];
            }

            clear(pattern = null) {
                if (pattern) {
                    const keys = this.keys().filter(k => k.startsWith(pattern));
                    keys.forEach(k => this.remove(k));
                } else {
                    this.keys()
                        .filter(k => k.startsWith('mlContractFlow:'))
                        .forEach(k => this.remove(k));
                }
            }

            keys() {
                const keys = [];
                try {
                    if (this.available) {
                        for (let i = 0; i < localStorage.length; i++) {
                            keys.push(localStorage.key(i));
                        }
                    }
                } catch (e) {
                    console.error('Error listing localStorage keys:', e);
                }
                Object.keys(this.memoryFallback).forEach(k => {
                    if (!keys.includes(k)) keys.push(k);
                });
                return keys;
            }
        }

        const storage = new StorageManager();

        // Storage keys
        const STORAGE_KEYS = {
            CONFIG: {
                API_KEY: 'mlContractFlow:config:apiKey',
                API_BASE_URL: 'mlContractFlow:config:apiBaseUrl',
                ENVIRONMENT: 'mlContractFlow:config:environment',
                COUNTRY_CODE: 'mlContractFlow:config:countryCode',
                CURRENCY: 'mlContractFlow:config:currency',
                LOCALE: 'mlContractFlow:config:locale',
                USE_RUBIKS_UI: 'mlContractFlow:config:useRubiksUI',
                REQUIRE_DD_SIG: 'mlContractFlow:config:requireDirectDebitSignature'
            },
            FLOW: {
                CURRENT_STEP: 'mlContractFlow:flow:currentStep',
                SELECTED_OFFER: 'mlContractFlow:flow:selectedOffer',
                FORM_DATA: 'mlContractFlow:flow:formData',
                PREVIEW_DATA: 'mlContractFlow:flow:previewData',
                TOKENS: 'mlContractFlow:flow:tokens',
                VOUCHERS: 'mlContractFlow:flow:vouchers',
                FINION_PAY_CUSTOMER_ID: 'mlContractFlow:flow:finionPayCustomerId'
            },
            UI: {
                CONFIG_PANEL: 'mlContractFlow:ui:configPanelOpen'
            }
        };

        const DATA_TTL = {
            CONFIG: 30 * 24 * 60 * 60 * 1000,
            FORM: 7 * 24 * 60 * 60 * 1000,
            OFFER: 24 * 60 * 60 * 1000,
            PREVIEW: 60 * 60 * 1000,
            TOKENS: 15 * 60 * 1000
        };

        // =================================================================
        // Additional JavaScript loaded from external files
        // =================================================================
    </script>

    <!-- Application JavaScript Modules -->
    <script src="contract-flow-app.js"></script>
    <script src="contract-flow-steps.js"></script>
</body>
</html>
